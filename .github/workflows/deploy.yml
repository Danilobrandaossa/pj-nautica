name: ðŸš€ Deploy to VPS

on:
  push:
    branches:
      - main
      - master
  workflow_dispatch: # Permite execuÃ§Ã£o manual

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ” Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.VPS_SSH_PRIVATE_KEY }}

      - name: ðŸ”§ Add VPS to known hosts
        run: |
          ssh-keyscan -H ${{ secrets.VPS_HOST }} >> ~/.ssh/known_hosts || true

      - name: ðŸš€ Deploy to VPS
        run: |
          ssh ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} << 'EOF'
            set -e
            
            echo "ðŸš€ Iniciando deploy..."
            
            # Navegar para o diretÃ³rio do projeto
            cd /opt/embarcacoes || {
              echo "âŒ DiretÃ³rio /opt/embarcacoes nÃ£o existe. Criando..."
              sudo mkdir -p /opt/embarcacoes
              sudo chown -R $USER:$USER /opt/embarcacoes
              cd /opt/embarcacoes
            }
            
            # Clonar ou atualizar repositÃ³rio
            if [ -d ".git" ]; then
              echo "ðŸ“¥ Atualizando cÃ³digo do GitHub..."
              git fetch origin
              git reset --hard origin/main || git reset --hard origin/master
              git clean -fd
            else
              echo "ðŸ“¥ Clonando repositÃ³rio..."
              git clone https://github.com/${{ github.repository }}.git .
            fi
            
            # Garantir que temos as permissÃµes
            sudo chown -R $USER:$USER /opt/embarcacoes
            
            # Verificar se .env existe
            if [ ! -f ".env" ]; then
              echo "âš ï¸  Arquivo .env nÃ£o encontrado. Criando a partir do exemplo..."
              if [ -f "env.production.example" ]; then
                cp env.production.example .env
                echo "ðŸ“ Configure as variÃ¡veis de ambiente no arquivo .env antes de continuar!"
              else
                echo "âŒ Arquivo env.production.example nÃ£o encontrado!"
                exit 1
              fi
            fi
            
            # Criar diretÃ³rios necessÃ¡rios
            mkdir -p nginx/ssl certbot/conf certbot/www
            
            # Executar script de deploy
            if [ -f "deploy-server.sh" ]; then
              chmod +x deploy-server.sh
              ./deploy-server.sh
            else
              echo "ðŸ”¨ Executando deploy manual..."
              
              # Parar containers existentes
              docker-compose -f docker-compose.prod.yml down || true
              
              # Build e iniciar containers
              echo "ðŸ—ï¸  Construindo containers..."
              docker-compose -f docker-compose.prod.yml build --no-cache
              
              echo "ðŸš€ Iniciando containers..."
              docker-compose -f docker-compose.prod.yml up -d
              
              # Aguardar containers iniciarem
              echo "â³ Aguardando containers iniciarem..."
              sleep 30
              
              # Executar migraÃ§Ãµes
              echo "ðŸ—„ï¸  Executando migraÃ§Ãµes do banco de dados..."
              docker-compose -f docker-compose.prod.yml exec -T backend npm run prisma:migrate || true
              
              # Limpar containers Ã³rfÃ£os
              docker-compose -f docker-compose.prod.yml up -d --remove-orphans
              
              echo "âœ… Deploy concluÃ­do!"
            fi
            
            # Verificar status dos containers
            echo "ðŸ“Š Status dos containers:"
            docker-compose -f docker-compose.prod.yml ps
            
            # Mostrar Ãºltimas linhas dos logs
            echo "ðŸ“‹ Ãšltimas linhas dos logs:"
            docker-compose -f docker-compose.prod.yml logs --tail=20
          EOF

      - name: âœ… Verificar Deploy
        run: |
          echo "ðŸ” Verificando se o servidor estÃ¡ respondendo..."
          sleep 10
          curl -f ${{ secrets.VPS_URL }}/api/health || echo "âš ï¸  Servidor ainda iniciando..."

      - name: ðŸ“¢ Notificar sucesso
        if: success()
        run: |
          echo "âœ… Deploy concluÃ­do com sucesso!"
          echo "ðŸŒ Sistema disponÃ­vel em: ${{ secrets.VPS_URL }}"

      - name: âŒ Notificar erro
        if: failure()
        run: |
          echo "âŒ Deploy falhou! Verifique os logs acima."


